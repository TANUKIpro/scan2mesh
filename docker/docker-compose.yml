# scan2mesh Docker Compose configuration
#
# Usage:
#   GPU version: docker compose up scan2mesh-gpu
#   CPU version: docker compose up scan2mesh-cpu
#   GUI version: docker compose up scan2mesh-gui
#
# For development, use docker-compose.dev.yml override:
#   docker compose -f docker-compose.yml -f docker-compose.dev.yml up scan2mesh-cpu
#   docker compose -f docker-compose.yml -f docker-compose.dev.yml up scan2mesh-gui

services:
  # ==========================================================================
  # GPU Version - Full functionality with NVIDIA GPU acceleration
  # ==========================================================================
  scan2mesh-gpu:
    build:
      context: ..
      dockerfile: docker/Dockerfile.gpu
    image: scan2mesh:gpu
    container_name: scan2mesh-gpu

    # NVIDIA GPU support
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

    # Security settings
    security_opt:
      - no-new-privileges:true

    # Environment variables
    environment:
      - SCAN2MESH_LOG_LEVEL=INFO
      - SCAN2MESH_PROJECT_DIR=/workspace/projects
      - CUDA_VISIBLE_DEVICES=0

    # Volume mounts
    volumes:
      - ../projects:/workspace/projects:rw
      - ../config:/workspace/config:ro
      - ../output:/workspace/output:rw

    # USB device access for RealSense camera
    devices:
      - /dev/bus/usb:/dev/bus/usb

    # Interactive terminal
    stdin_open: true
    tty: true

    # Restart policy
    restart: "no"

  # ==========================================================================
  # CPU Version - Lightweight version for development and CI/CD
  # ==========================================================================
  scan2mesh-cpu:
    build:
      context: ..
      dockerfile: docker/Dockerfile.cpu
    image: scan2mesh:cpu
    container_name: scan2mesh-cpu

    # Security settings
    security_opt:
      - no-new-privileges:true

    # Environment variables
    environment:
      - SCAN2MESH_LOG_LEVEL=INFO
      - SCAN2MESH_PROJECT_DIR=/workspace/projects

    # Volume mounts
    volumes:
      - ../projects:/workspace/projects:rw
      - ../config:/workspace/config:ro
      - ../output:/workspace/output:rw

    # Interactive terminal
    stdin_open: true
    tty: true

    # Restart policy
    restart: "no"

  # ==========================================================================
  # GUI Version - Streamlit-based web interface
  # ==========================================================================
  scan2mesh-gui:
    build:
      context: ..
      dockerfile: docker/Dockerfile.gui
    image: scan2mesh:gui
    container_name: scan2mesh-gui

    # Security settings
    security_opt:
      - no-new-privileges:true

    # Port mapping for Streamlit
    ports:
      - "8501:8501"

    # Environment variables
    environment:
      - SCAN2MESH_LOG_LEVEL=INFO
      - SCAN2MESH_PROJECT_DIR=/workspace/projects
      - STREAMLIT_SERVER_PORT=8501
      - STREAMLIT_SERVER_ADDRESS=0.0.0.0
      - STREAMLIT_SERVER_HEADLESS=true
      - STREAMLIT_BROWSER_GATHER_USAGE_STATS=false

    # Volume mounts
    volumes:
      - ../projects:/workspace/projects:rw
      - ../profiles:/workspace/profiles:rw
      - ../config:/workspace/config:ro
      - ../output:/workspace/output:rw

    # USB device access for RealSense camera
    devices:
      - /dev/bus/usb:/dev/bus/usb

    # Restart policy
    restart: "no"

